<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.mycompany.miniproject.dao.OrderDAO">
	
	<select id="getSelectedProduct" parameterType="Cart" resultType="Cart">
		SELECT 
			c.member_id,
			p.product_id,
			c.cart_count,
			p.product_name,
			p.product_price
		FROM
			CART c
		JOIN 
			PRODUCT p
		USING(product_id)
		WHERE
			member_id=#{memberId}
		AND product_id = #{productId}
	
	
	</select>
	
	<select id="selectAllCount" resultType="int">
		<![CDATA[
			SELECT COUNT(*)
			FROM "order"
			ORDER BY order_date DESC
		]]>
	</select>
	
	<select id="selectAllOrderList" parameterType="Pager" resultType="Order">
		<![CDATA[
			SELECT
			    order_number,
			    order_date,
			    order_memo,
			    delivery_num,
			    delivery_post_num,
			    delivery_address,
			    delivery_address_detail,
			    receiver_name,
			    receiver_phone_num,
			    delivery_memo,
			    delivery_price,
			    delivery_status,
			    order_total_price,
			    member_id,
			    product_id,
			    order_product_count,
			    order_product_price
			FROM (
			    SELECT
				    order_number,
				    order_date,
				    order_memo,
				    delivery_num,
				    delivery_post_num,
				    delivery_address,
				    delivery_address_detail,
				    receiver_name,
				    receiver_phone_num,
				    delivery_memo,
				    delivery_price,
				    delivery_status,
				    order_total_price,
				    member_id,
				    product_id,
				    order_product_count,
				    order_product_price,
			        ROW_NUMBER() OVER (ORDER BY order_number DESC) AS rnum
			    FROM 
			    	"order"
			    	LEFT OUTER JOIN ORDER_PRODUCT USING(order_number)
			)
			WHERE rnum BETWEEN #{startRowNo} AND #{endRowNo}
		]]>
	</select>
	
	<insert id="insertOrder" parameterType="Order" >
		<![CDATA[
			INSERT INTO "order"
			VALUES (
				seq_order_number.nextval,
				sysdate,
				#{orderMemo},
				seq_delivery_num.nextval,
				#{deliveryPostNum},
				#{deliveryAddress},
				#{deliveryAddressDetail},
				#{receiverName},
				#{receiverPhoneNum},
				#{deliveryMemo},
				#{deliveryPrice},
				#{deliveryStatus},
				#{orderTotalPrice},
				#{memberId}
			)
		]]>	
	</insert>
	
	<select id="selectRecentOrderNumber" parameterType="Order" resultType="int">
		<![CDATA[
			SELECT order_number
			FROM "order"
			WHERE member_id = #{memberId}
			ORDER BY order_date DESC
			FETCH FIRST 1 ROWS ONLY
		]]>
	</select>

</mapper>