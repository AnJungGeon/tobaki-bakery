<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.mycompany.miniproject.dao.ProductReviewDAO">

<!-- 특정 회원이 특정 제품에 대한 후기를 작성할 수 있는지 확인 -->
    <select id="canWriteReview" parameterType="map" resultType="boolean">
        <![CDATA[
        SELECT COUNT(*) > 0
        FROM ORDERS o
        JOIN ORDER_DETAIL od ON o.order_id = od.order_id
        WHERE o.member_id = #{memberId}
          AND od.product_id = #{productId}
        ]]>
    </select>

    <!-- 후기 저장 -->
    <insert id="insertProductReview" parameterType="ProductReview">
        <![CDATA[
        INSERT INTO PRODUCT_REVIEW (
            review_title,
            review_content,
            review_point,
            review_views,
            review_date,
            member_id,
            product_id,
            image_original_name,
            image_type,
            image_data
        ) VALUES (
            #{reviewTitle},
            #{reviewContent},
            #{reviewPoint},
            0,
            NOW(),
            #{memberId},
            #{productId},
            #{imageOriginalName},
            #{imageType},
            #{imageData}
        )
        ]]>
    </insert>

    <!-- 특정 상품의 모든 후기 조회 -->
    <select id="selectReviewsByProductId" parameterType="string" resultType="ProductReview">
        <![CDATA[
        SELECT 
            pr.product_review_id,
            pr.review_title,
            pr.review_content,
            pr.review_point,
            pr.review_views,
            pr.review_date,
            pr.member_id,
            pr.product_id,
            ci.image_original_name,
            ci.image_type,
            ci.image_data
        FROM 
            PRODUCT_REVIEW pr
            LEFT OUTER JOIN center_image ci ON pr.product_review_id = ci.product_review_id
        WHERE 
            pr.member_id = #{memberId}
        ORDER BY 
            pr.review_date DESC
        ]]>
    </select>
    
   
    
    <select id="selectReviewsByMemberId" resultType="ProductReview">
    SELECT * 
    FROM product_review 
    WHERE member_id = #{memberId}
	</select>
    
 
</mapper>