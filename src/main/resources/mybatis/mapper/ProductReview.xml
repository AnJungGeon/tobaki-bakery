<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.mycompany.miniproject.dao.ProductReviewDAO">

<!-- 특정 회원이 특정 제품에 대한 후기를 작성할 수 있는지 확인 -->
    <select id="canWriteReview" parameterType="map" resultType="boolean">
        <![CDATA[
        SELECT COUNT(*) > 0
        FROM ORDERS o
        JOIN ORDER_DETAIL od ON o.order_id = od.order_id
        WHERE o.member_id = #{memberId}
          AND od.product_id = #{productId}
        ]]>
    </select>

    <!-- 후기 저장 -->
    <insert id="insertProductReview" parameterType="ProductReview">
        <![CDATA[
        INSERT INTO PRODUCT_REVIEW (
            review_title,
            review_content,
            review_point,
            review_views,
            review_date,
            member_id,
            product_id,
            image_original_name,
            image_type,
            image_data
        ) VALUES (
            #{reviewTitle},
            #{reviewContent},
            #{reviewPoint},
            0,
            NOW(),
            #{memberId},
            #{productId},
            #{imageOriginalName},
            #{imageType},
            #{imageData}
        )
        ]]>
    </insert>

    <!-- 특정 상품의 리뷰리스트 조회 -->
    <select id="getReviewsByProductId" parameterType="int" resultType="ProductReview">
    	<![CDATA[
        SELECT 
	        PR.PRODUCT_REVIEW_ID, 
	        PR.REVIEW_TITLE, 
	        PR.REVIEW_CONTENT, 
	        PR.REVIEW_POINT, 
	        PR.REVIEW_VIEWS, 
	        PR.REVIEW_DATE, 
	        PR.MEMBER_ID,
            CI.IMAGE_ORIGINAL_NAME, 
            CI.IMAGE_TYPE, 
            CI.IMAGE_DATA
        FROM 
        	PRODUCT_REVIEW PR
        LEFT 
        	JOIN CENTER_IMAGE CI 
       	ON 
       		PR.PRODUCT_REVIEW_ID = CI.PRODUCT_REVIEW_ID
        WHERE 
        	PR.PRODUCT_ID = #{productId}
       	]]>
    </select>
   
    <select id="selectReviewsByMemberId" resultType="ProductReview">
    SELECT * 
    FROM product_review 
    WHERE member_id = #{memberId}
	</select>
    
    
 
</mapper>